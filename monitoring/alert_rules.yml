"""
Prometheus Alerting Rules for N1V1 Trading Framework

This file defines alerting rules for monitoring the N1V1 trading framework.
Alerts are categorized by severity and include appropriate thresholds for
trading system monitoring.

Alert Categories:
- Critical: Immediate action required (trading stopped, data loss)
- Warning: Action needed within business hours (performance degradation)
- Info: Monitoring alerts (trend analysis, capacity planning)
"""

groups:
  # Critical Trading Alerts - Immediate Response Required
  - name: n1v1_trading_critical
    rules:
      # Trading System Down
      - alert: TradingSystemDown
        expr: up{job="n1v1-trading-framework"} == 0
        for: 30s
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "Trading system is down"
          description: "N1V1 trading framework has been down for more than 30 seconds"
          runbook_url: "https://docs.n1v1.com/runbooks/trading-system-down"

      # Circuit Breaker Triggered
      - alert: CircuitBreakerTriggered
        expr: risk_circuit_breaker_status{account="main"} == 1
        for: 10s
        labels:
          severity: critical
          category: risk
        annotations:
          summary: "Circuit breaker activated"
          description: "Risk management circuit breaker has been triggered. Trading suspended."
          runbook_url: "https://docs.n1v1.com/runbooks/circuit-breaker"

      # High Drawdown Alert
      - alert: ExcessiveDrawdown
        expr: trading_max_drawdown_percent{account="main"} > 15
        for: 60s
        labels:
          severity: critical
          category: risk
        annotations:
          summary: "Excessive portfolio drawdown"
          description: "Portfolio drawdown has exceeded 15% threshold"
          runbook_url: "https://docs.n1v1.com/runbooks/excessive-drawdown"

      # Exchange Connectivity Lost
      - alert: ExchangeConnectivityLost
        expr: exchange_connectivity_status == 0
        for: 30s
        labels:
          severity: critical
          category: connectivity
        annotations:
          summary: "Exchange connectivity lost"
          description: "Lost connectivity to {{ $labels.exchange }} exchange"
          runbook_url: "https://docs.n1v1.com/runbooks/exchange-connectivity"

      # Data Feed Disruption
      - alert: DataFeedDisruption
        expr: increase(trading_order_latency_seconds{exchange=~".+"}[5m]) > 10
        for: 60s
        labels:
          severity: critical
          category: data
        annotations:
          summary: "Data feed disruption detected"
          description: "Order latency has increased significantly on {{ $labels.exchange }}"
          runbook_url: "https://docs.n1v1.com/runbooks/data-feed-disruption"

  # High Priority Trading Alerts - Action Within 15 Minutes
  - name: n1v1_trading_high
    rules:
      # Performance Degradation
      - alert: TradingPerformanceDegraded
        expr: trading_order_latency_seconds{account="main"} > 0.5
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Trading performance degraded"
          description: "Average order latency has exceeded 500ms for 5 minutes"
          runbook_url: "https://docs.n1v1.com/runbooks/performance-degradation"

      # Risk Limits Approaching
      - alert: RiskLimitsApproaching
        expr: risk_portfolio_exposure_usd{account="main"} > 20000
        for: 2m
        labels:
          severity: warning
          category: risk
        annotations:
          summary: "Risk limits approaching"
          description: "Portfolio exposure has exceeded $20,000 threshold"
          runbook_url: "https://docs.n1v1.com/runbooks/risk-limits"

      # Strategy Performance Decline
      - alert: StrategyPerformanceDecline
        expr: strategy_win_rate_ratio < 0.5
        for: 10m
        labels:
          severity: warning
          category: strategy
        annotations:
          summary: "Strategy performance declining"
          description: "Strategy {{ $labels.strategy }} win rate below 50%"
          runbook_url: "https://docs.n1v1.com/runbooks/strategy-performance"

      # Memory Usage High
      - alert: HighMemoryUsage
        expr: (1 - system_memory_usage_bytes / system_memory_total_bytes) > 0.85
        for: 5m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "High memory usage"
          description: "System memory usage above 85%"
          runbook_url: "https://docs.n1v1.com/runbooks/high-memory-usage"

      # CPU Usage High
      - alert: HighCpuUsage
        expr: system_cpu_usage_percent > 80
        for: 5m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "High CPU usage"
          description: "System CPU usage above 80%"
          runbook_url: "https://docs.n1v1.com/runbooks/high-cpu-usage"

  # Medium Priority Trading Alerts - Action Within Business Hours
  - name: n1v1_trading_medium
    rules:
      # Sharpe Ratio Decline
      - alert: SharpeRatioDecline
        expr: trading_sharpe_ratio{account="main"} < 0.5
        for: 1h
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Sharpe ratio declining"
          description: "Portfolio Sharpe ratio has fallen below 0.5"
          runbook_url: "https://docs.n1v1.com/runbooks/sharpe-ratio-decline"

      # Win Rate Decline
      - alert: WinRateDecline
        expr: trading_win_rate_ratio{account="main"} < 0.55
        for: 30m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Win rate declining"
          description: "Trading win rate has fallen below 55%"
          runbook_url: "https://docs.n1v1.com/runbooks/win-rate-decline"

      # Exchange Rate Limit Approaching
      - alert: ExchangeRateLimitApproaching
        expr: exchange_rate_limit_usage_ratio > 0.8
        for: 5m
        labels:
          severity: warning
          category: exchange
        annotations:
          summary: "Exchange rate limit approaching"
          description: "Rate limit usage on {{ $labels.exchange }} above 80%"
          runbook_url: "https://docs.n1v1.com/runbooks/rate-limit-approaching"

      # Strategy Signal Quality Decline
      - alert: StrategySignalQualityDecline
        expr: strategy_signal_quality_ratio < 0.7
        for: 15m
        labels:
          severity: info
          category: strategy
        annotations:
          summary: "Strategy signal quality declining"
          description: "Signal quality for {{ $labels.strategy }} below 70%"
          runbook_url: "https://docs.n1v1.com/runbooks/signal-quality"

      # Disk Space Low
      - alert: DiskSpaceLow
        expr: (1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) > 0.8
        for: 10m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "Disk space running low"
          description: "Disk space usage above 80% on {{ $labels.mountpoint }}"
          runbook_url: "https://docs.n1v1.com/runbooks/disk-space-low"

  # Low Priority / Informational Alerts
  - name: n1v1_trading_info
    rules:
      # Daily Performance Summary
      - alert: DailyPerformanceSummary
        expr: increase(trading_total_pnl_usd[24h]) < -1000
        for: 0s  # Immediate alert
        labels:
          severity: info
          category: performance
        annotations:
          summary: "Daily loss threshold exceeded"
          description: "Daily P&L has decreased by more than $1000"
          runbook_url: "https://docs.n1v1.com/runbooks/daily-performance"

      # Unusual Trading Volume
      - alert: UnusualTradingVolume
        expr: increase(trading_orders_total[1h]) > 1000
        for: 0s
        labels:
          severity: info
          category: volume
        annotations:
          summary: "Unusual trading volume detected"
          description: "Order volume has exceeded 1000 orders per hour"
          runbook_url: "https://docs.n1v1.com/runbooks/unusual-volume"

      # New Strategy Performance
      - alert: NewStrategyHighPerformance
        expr: strategy_win_rate_ratio > 0.75
        for: 1h
        labels:
          severity: info
          category: strategy
        annotations:
          summary: "New strategy showing high performance"
          description: "Strategy {{ $labels.strategy }} has win rate above 75%"
          runbook_url: "https://docs.n1v1.com/runbooks/new-strategy-performance"

      # Binary Model Trade Frequency Drift
      - alert: BinaryModelTradeFrequencyDrift
        expr: binary_model_drift_trade_frequency_change > 0.5
        for: 30m
        labels:
          severity: warning
          category: model
        annotations:
          summary: "Binary model trade frequency drift detected"
          description: "Trade frequency changed by {{ $value }}% from historical baseline"
          runbook_url: "https://docs.n1v1.com/runbooks/binary-model-drift"

      # Binary Model Accuracy Drop
      - alert: BinaryModelAccuracyDrop
        expr: binary_model_accuracy < 0.5
        for: 1h
        labels:
          severity: critical
          category: model
        annotations:
          summary: "Binary model accuracy critically low"
          description: "Binary model accuracy dropped to {{ $value }}%"
          runbook_url: "https://docs.n1v1.com/runbooks/binary-model-accuracy"

      # Binary Model Calibration Error
      - alert: BinaryModelCalibrationError
        expr: binary_model_calibration_error > 0.2
        for: 2h
        labels:
          severity: warning
          category: model
        annotations:
          summary: "Binary model calibration error detected"
          description: "Model calibration error: {{ $value }} (expected < 0.2)"
          runbook_url: "https://docs.n1v1.com/runbooks/binary-model-calibration"

      # Binary Model Prediction Stability
      - alert: BinaryModelPredictionInstability
        expr: binary_model_prediction_stability > 1.0
        for: 1h
        labels:
          severity: warning
          category: model
        annotations:
          summary: "Binary model prediction instability"
          description: "Prediction stability coefficient: {{ $value }} (high variance detected)"
          runbook_url: "https://docs.n1v1.com/runbooks/binary-model-stability"

      # Model Drift Detection
      - alert: ModelDriftDetected
        expr: model_drift_score > 0.2
        for: 30m
        labels:
          severity: warning
          category: model
        annotations:
          summary: "Model drift detected"
          description: "Model drift score: {{ $value }} (threshold: 0.2)"
          runbook_url: "https://docs.n1v1.com/runbooks/model-drift"

      # Feature Drift Detection
      - alert: FeatureDriftDetected
        expr: feature_drift_score > 0.15
        for: 1h
        labels:
          severity: warning
          category: model
        annotations:
          summary: "Feature drift detected"
          description: "Feature drift score: {{ $value }} (threshold: 0.15)"
          runbook_url: "https://docs.n1v1.com/runbooks/feature-drift"

      # Model Performance Degradation
      - alert: ModelPerformanceDegraded
        expr: model_performance_score < 0.6
        for: 2h
        labels:
          severity: warning
          category: model
        annotations:
          summary: "Model performance degraded"
          description: "Model performance score: {{ $value }} (threshold: 0.6)"
          runbook_url: "https://docs.n1v1.com/runbooks/model-performance"

      # Model Calibration Error High
      - alert: ModelCalibrationErrorHigh
        expr: model_calibration_error > 0.3
        for: 1h
        labels:
          severity: warning
          category: model
        annotations:
          summary: "Model calibration error too high"
          description: "Model calibration error: {{ $value }} (threshold: 0.3)"
          runbook_url: "https://docs.n1v1.com/runbooks/model-calibration"

      # Ensemble Model Disagreement
      - alert: EnsembleModelDisagreement
        expr: ensemble_model_disagreement > 0.8
        for: 30m
        labels:
          severity: info
          category: model
        annotations:
          summary: "Ensemble model disagreement detected"
          description: "Ensemble model disagreement score: {{ $value }} (high uncertainty)"
          runbook_url: "https://docs.n1v1.com/runbooks/ensemble-disagreement"

      # Model Retraining Required
      - alert: ModelRetrainingRequired
        expr: model_retraining_required == 1
        for: 10m
        labels:
          severity: critical
          category: model
        annotations:
          summary: "Model retraining required"
          description: "Model health assessment indicates retraining is required"
          runbook_url: "https://docs.n1v1.com/runbooks/model-retraining"

      # Dataset Drift Detection
      - alert: DatasetDriftDetected
        expr: dataset_drift_score > 0.25
        for: 1h
        labels:
          severity: warning
          category: data
        annotations:
          summary: "Dataset drift detected"
          description: "Dataset drift score: {{ $value }} (threshold: 0.25)"
          runbook_url: "https://docs.n1v1.com/runbooks/dataset-drift"

      # Model Serving Latency High
      - alert: ModelServingLatencyHigh
        expr: histogram_quantile(0.95, rate(model_serving_latency_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
          category: serving
        annotations:
          summary: "Model serving latency too high"
          description: "95th percentile serving latency exceeded 500ms"
          runbook_url: "https://docs.n1v1.com/runbooks/model-serving-latency"

      # Model Serving Error Rate High
      - alert: ModelServingErrorRateHigh
        expr: rate(model_serving_requests_total{status="error"}[5m]) / rate(model_serving_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          category: serving
        annotations:
          summary: "Model serving error rate too high"
          description: "Model serving error rate exceeded 5%"
          runbook_url: "https://docs.n1v1.com/runbooks/model-serving-errors"

      # System Resource Trends
      - alert: MemoryUsageTrend
        expr: predict_linear(system_memory_usage_bytes[1h], 3600) > system_memory_total_bytes * 0.9
        for: 0s
        labels:
          severity: info
          category: capacity
        annotations:
          summary: "Memory usage trending high"
          description: "Memory usage projected to exceed 90% in 1 hour"
          runbook_url: "https://docs.n1v1.com/runbooks/memory-trend"

      # Network Latency Increase
      - alert: NetworkLatencyIncrease
        expr: increase(exchange_latency_seconds[10m]) > 0.1
        for: 5m
        labels:
          severity: info
          category: network
        annotations:
          summary: "Network latency increasing"
          description: "Network latency to {{ $labels.exchange }} has increased by 100ms"
          runbook_url: "https://docs.n1v1.com/runbooks/network-latency"

  # Recovery Alerts
  - name: n1v1_trading_recovery
    rules:
      # System Recovery
      - alert: TradingSystemRecovered
        expr: up{job="n1v1-trading-framework"} == 1
        for: 30s
        labels:
          severity: info
          category: recovery
        annotations:
          summary: "Trading system recovered"
          description: "N1V1 trading framework has recovered and is running"
          runbook_url: "https://docs.n1v1.com/runbooks/system-recovery"

      # Circuit Breaker Reset
      - alert: CircuitBreakerReset
        expr: risk_circuit_breaker_status{account="main"} == 0
        for: 10s
        labels:
          severity: info
          category: recovery
        annotations:
          summary: "Circuit breaker reset"
          description: "Risk management circuit breaker has been reset"
          runbook_url: "https://docs.n1v1.com/runbooks/circuit-breaker-reset"

      # Exchange Connectivity Restored
      - alert: ExchangeConnectivityRestored
        expr: exchange_connectivity_status == 1
        for: 30s
        labels:
          severity: info
          category: recovery
        annotations:
          summary: "Exchange connectivity restored"
          description: "Connectivity to {{ $labels.exchange }} exchange has been restored"
          runbook_url: "https://docs.n1v1.com/runbooks/exchange-connectivity-restored"

      # Performance Recovered
      - alert: TradingPerformanceRecovered
        expr: trading_order_latency_seconds{account="main"} < 0.2
        for: 2m
        labels:
          severity: info
          category: recovery
        annotations:
          summary: "Trading performance recovered"
          description: "Order latency has returned to normal levels (< 200ms)"
          runbook_url: "https://docs.n1v1.com/runbooks/performance-recovery"

  # Capacity Planning Alerts
  - name: n1v1_capacity_planning
    rules:
      # Database Connection Pool Usage
      - alert: DatabaseConnectionPoolHigh
        expr: rate(postgresql_active_connections[5m]) / postgresql_max_connections > 0.8
        for: 10m
        labels:
          severity: info
          category: capacity
        annotations:
          summary: "Database connection pool usage high"
          description: "Database connection pool usage above 80%"
          runbook_url: "https://docs.n1v1.com/runbooks/db-connection-pool"

      # Redis Memory Usage
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
        for: 10m
        labels:
          severity: info
          category: capacity
        annotations:
          summary: "Redis memory usage high"
          description: "Redis memory usage above 80%"
          runbook_url: "https://docs.n1v1.com/runbooks/redis-memory"

      # Queue Backlog
      - alert: OrderQueueBacklog
        expr: trading_order_queue_length > 100
        for: 5m
        labels:
          severity: info
          category: capacity
        annotations:
          summary: "Order queue backlog detected"
          description: "Order queue length has exceeded 100 orders"
          runbook_url: "https://docs.n1v1.com/runbooks/queue-backlog"

      # API Rate Limit Trends
      - alert: ApiRateLimitTrend
        expr: predict_linear(exchange_rate_limit_usage_ratio[1h], 3600) > 0.95
        for: 0s
        labels:
          severity: info
          category: capacity
        annotations:
          summary: "API rate limit trending to limit"
          description: "API rate limit usage projected to reach 95% in 1 hour"
          runbook_url: "https://docs.n1v1.com/runbooks/api-rate-limit-trend"

  # ML Serving Infrastructure Alerts
  - name: n1v1_ml_serving
    rules:
      # ML Serving Service Down
      - alert: MLServingServiceDown
        expr: up{job="n1v1-ml-serving"} == 0
        for: 30s
        labels:
          severity: critical
          category: ml-serving
        annotations:
          summary: "ML serving service is down"
          description: "ML serving infrastructure has been down for more than 30 seconds"
          runbook_url: "https://docs.n1v1.com/runbooks/ml-serving-down"

      # High ML Inference Latency
      - alert: MLInferenceHighLatency
        expr: histogram_quantile(0.95, rate(inference_latency_seconds_bucket[5m])) > 0.1
        for: 2m
        labels:
          severity: warning
          category: ml-serving
        annotations:
          summary: "ML inference latency too high"
          description: "95th percentile inference latency exceeded 100ms for 2 minutes"
          runbook_url: "https://docs.n1v1.com/runbooks/ml-high-latency"

      # ML Inference Error Rate High
      - alert: MLInferenceHighErrorRate
        expr: rate(inference_requests_total{status="error"}[5m]) / rate(inference_requests_total[5m]) > 0.01
        for: 5m
        labels:
          severity: warning
          category: ml-serving
        annotations:
          summary: "ML inference error rate too high"
          description: "ML inference error rate exceeded 1% for 5 minutes"
          runbook_url: "https://docs.n1v1.com/runbooks/ml-high-error-rate"

      # ML Serving High Memory Usage
      - alert: MLServingHighMemoryUsage
        expr: container_memory_usage_bytes{pod=~"n1v1-ml-serving-.*"} / container_spec_memory_limit_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          category: ml-serving
        annotations:
          summary: "ML serving high memory usage"
          description: "ML serving pod memory usage above 90%"
          runbook_url: "https://docs.n1v1.com/runbooks/ml-high-memory"

      # ML Serving High CPU Usage
      - alert: MLServingHighCpuUsage
        expr: rate(container_cpu_usage_seconds_total{pod=~"n1v1-ml-serving-.*"}[5m]) / container_spec_cpu_limit_cores > 0.8
        for: 5m
        labels:
          severity: warning
          category: ml-serving
        annotations:
          summary: "ML serving high CPU usage"
          description: "ML serving pod CPU usage above 80%"
          runbook_url: "https://docs.n1v1.com/runbooks/ml-high-cpu"

      # ML Model Loading Failed
      - alert: MLModelLoadingFailed
        expr: increase(ml_model_load_errors_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          category: ml-serving
        annotations:
          summary: "ML model loading failed"
          description: "Failed to load ML model in serving infrastructure"
          runbook_url: "https://docs.n1v1.com/runbooks/ml-model-load-failure"

      # ML Serving Queue Backlog
      - alert: MLServingQueueBacklog
        expr: ml_serving_queue_length > 100
        for: 2m
        labels:
          severity: warning
          category: ml-serving
        annotations:
          summary: "ML serving queue backlog"
          description: "ML serving request queue length exceeded 100"
          runbook_url: "https://docs.n1v1.com/runbooks/ml-queue-backlog"

      # ML Serving Recovery
      - alert: MLServingServiceRecovered
        expr: up{job="n1v1-ml-serving"} == 1
        for: 30s
        labels:
          severity: info
          category: ml-serving
        annotations:
          summary: "ML serving service recovered"
          description: "ML serving infrastructure has recovered and is running"
          runbook_url: "https://docs.n1v1.com/runbooks/ml-serving-recovery"

  # Security Alerts - Critical Security Events
  - name: n1v1_security_critical
    rules:
      # Security Violation Detected
      - alert: SecurityViolationDetected
        expr: security_violation_total > 0
        for: 10s
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Security violation detected"
          description: "A security violation has been detected in the trading system"
          runbook_url: "https://docs.n1v1.com/runbooks/security-violation"

      # Key Management Service Down
      - alert: KeyManagementServiceDown
        expr: key_management_service_status == 0
        for: 30s
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Key management service is down"
          description: "Vault/KMS service is unavailable - credential access may be compromised"
          runbook_url: "https://docs.n1v1.com/runbooks/key-management-down"

      # Invalid API Key Detected
      - alert: InvalidApiKeyDetected
        expr: increase(invalid_api_key_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Invalid API key detected"
          description: "Invalid or expired API key detected in authentication attempts"
          runbook_url: "https://docs.n1v1.com/runbooks/invalid-api-key"

      # Expired Key Detected
      - alert: ExpiredKeyDetected
        expr: increase(expired_key_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Expired key detected"
          description: "Expired cryptographic key detected in the system"
          runbook_url: "https://docs.n1v1.com/runbooks/expired-key"

      # Multiple Failed Authentication Attempts
      - alert: MultipleFailedAuthAttempts
        expr: increase(failed_auth_attempts_total[5m]) > 5
        for: 2m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Multiple failed authentication attempts"
          description: "Multiple failed authentication attempts detected - potential brute force attack"
          runbook_url: "https://docs.n1v1.com/runbooks/failed-auth-attempts"

      # Invalid Order Schema Detected
      - alert: InvalidOrderSchemaDetected
        expr: increase(order_schema_validation_errors_total[5m]) > 5
        for: 2m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Invalid order schemas detected"
          description: "Multiple orders with invalid schemas detected in the last 5 minutes"
          runbook_url: "https://docs.n1v1.com/runbooks/invalid-order-schema"

      # Duplicate Order ID Detected
      - alert: DuplicateOrderIdDetected
        expr: increase(duplicate_order_id_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Duplicate order ID detected"
          description: "Duplicate order IDs detected - potential replay attack or system error"
          runbook_url: "https://docs.n1v1.com/runbooks/duplicate-order-id"

      # Rate Limit Exceeded
      - alert: RateLimitExceeded
        expr: increase(rate_limit_exceeded_total[1m]) > 10
        for: 2m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Rate limit exceeded multiple times"
          description: "Rate limits have been exceeded more than 10 times in the last minute"
          runbook_url: "https://docs.n1v1.com/runbooks/rate-limit-exceeded"

  # Security Alerts - High Priority
  - name: n1v1_security_high
    rules:
      # Abnormal Order Cancellation Rate
      - alert: AbnormalOrderCancellationRate
        expr: rate(order_cancellation_total[5m]) / rate(order_execution_total[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Abnormal order cancellation rate"
          description: "Order cancellation rate exceeds 50% of total orders"
          runbook_url: "https://docs.n1v1.com/runbooks/abnormal-cancellation-rate"

      # API Key Usage Spike
      - alert: ApiKeyUsageSpike
        expr: increase(api_key_usage_total[5m]) > 100
        for: 3m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "API key usage spike detected"
          description: "API key usage has increased by more than 100 requests in 5 minutes"
          runbook_url: "https://docs.n1v1.com/runbooks/api-key-usage-spike"

      # Unauthorized Access Attempts
      - alert: UnauthorizedAccessAttempts
        expr: increase(unauthorized_access_total[5m]) > 5
        for: 2m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Unauthorized access attempts detected"
          description: "Multiple unauthorized access attempts detected"
          runbook_url: "https://docs.n1v1.com/runbooks/unauthorized-access"

      # Order State Inconsistency
      - alert: OrderStateInconsistency
        expr: order_state_inconsistencies_total > 0
        for: 5m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Order state inconsistency detected"
          description: "Order state inconsistencies detected in the system"
          runbook_url: "https://docs.n1v1.com/runbooks/order-state-inconsistency"

      # Stale Orders Detected
      - alert: StaleOrdersDetected
        expr: stale_orders_total > 10
        for: 10m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Stale orders detected"
          description: "More than 10 orders have been pending for over 24 hours"
          runbook_url: "https://docs.n1v1.com/runbooks/stale-orders"

  # Security Alerts - Medium Priority
  - name: n1v1_security_medium
    rules:
      # Key Rotation Overdue
      - alert: KeyRotationOverdue
        expr: key_rotation_overdue_days > 30
        for: 1h
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Key rotation overdue"
          description: "API keys or credentials have not been rotated for more than 30 days"
          runbook_url: "https://docs.n1v1.com/runbooks/key-rotation-overdue"

      # Security Event Rate Increase
      - alert: SecurityEventRateIncrease
        expr: increase(security_events_total[10m]) > 20
        for: 5m
        labels:
          severity: info
          category: security
        annotations:
          summary: "Security event rate increased"
          description: "Security event rate has increased significantly"
          runbook_url: "https://docs.n1v1.com/runbooks/security-event-rate"

      # Credential Access Audit Alert
      - alert: CredentialAccessAuditAlert
        expr: increase(credential_access_total[1h]) > 1000
        for: 10m
        labels:
          severity: info
          category: security
        annotations:
          summary: "High credential access rate"
          description: "Credential access rate exceeds normal thresholds"
          runbook_url: "https://docs.n1v1.com/runbooks/credential-access-rate"

      # Signal Validation Failure Rate
      - alert: SignalValidationFailureRate
        expr: rate(signal_validation_failures_total[5m]) / rate(signal_validation_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Signal validation failure rate high"
          description: "Signal validation failure rate exceeds 10%"
          runbook_url: "https://docs.n1v1.com/runbooks/signal-validation-failure"

  # Security Recovery Alerts
  - name: n1v1_security_recovery
    rules:
      # Key Management Service Recovered
      - alert: KeyManagementServiceRecovered
        expr: key_management_service_status == 1
        for: 30s
        labels:
          severity: info
          category: security
        annotations:
          summary: "Key management service recovered"
          description: "Vault/KMS service has recovered and is operational"
          runbook_url: "https://docs.n1v1.com/runbooks/key-management-recovered"

      # Security Violation Resolved
      - alert: SecurityViolationResolved
        expr: security_violation_total == 0
        for: 5m
        labels:
          severity: info
          category: security
        annotations:
          summary: "Security violations resolved"
          description: "All security violations have been resolved"
          runbook_url: "https://docs.n1v1.com/runbooks/security-violation-resolved"

      # Order Flow Consistency Restored
      - alert: OrderFlowConsistencyRestored
        expr: order_state_inconsistencies_total == 0
        for: 2m
        labels:
          severity: info
          category: security
        annotations:
          summary: "Order flow consistency restored"
          description: "Order flow consistency has been restored"
          runbook_url: "https://docs.n1v1.com/runbooks/order-consistency-restored"
